name: Build Phantom OS ISO (Custom Kernel + WebKit)

on:
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest

    env:
      KERNEL_VERSION: 6.6.11
      ISO_NAME: Phantom-OS.iso

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential libncurses-dev bison flex libssl-dev libelf-dev \
            wget git xorriso grub-pc-bin grub-efi-amd64-bin mtools \
            debootstrap squashfs-tools cpio gzip \
            webkit2gtk-4.1-dev libgtk-3-dev gcc pkg-config

      - name: Download Linux kernel
        run: |
          mkdir -p kernel-src
          wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${KERNEL_VERSION}.tar.xz
          tar xf linux-${KERNEL_VERSION}.tar.xz -C kernel-src --strip-components=1

      - name: Configure and compile kernel
        run: |
          cd kernel-src
          make defconfig
          scripts/config --enable CONFIG_FB
          scripts/config --enable CONFIG_FRAMEBUFFER_CONSOLE
          scripts/config --enable CONFIG_DRM
          scripts/config --enable CONFIG_DRM_FBDEV_EMULATION
          scripts/config --enable CONFIG_WIRELESS
          scripts/config --enable CONFIG_CFG80211
          scripts/config --enable CONFIG_MAC80211
          make -j$(nproc)

      - name: Install kernel modules
        run: |
          cd kernel-src
          mkdir -p ../rootfs
          make modules_install INSTALL_MOD_PATH=../rootfs

      - name: Build minimal rootfs with debootstrap
        run: |
          sudo debootstrap --arch=amd64 jammy rootfs http://archive.ubuntu.com/ubuntu/
          sudo chroot rootfs /bin/bash -c "
            apt update &&
            apt install -y systemd webkit2gtk-4.1 libgtk-3-0 xorg xinit gcc pkg-config libwebkit2gtk-4.1-dev
          "

      - name: Create WebKit launcher
        run: |
          sudo mkdir -p rootfs/usr/local/bin
          sudo tee rootfs/usr/local/bin/phantom-shell.c > /dev/null << 'EOF'
          #include <gtk/gtk.h>
          #include <webkit2/webkit2.h>

          int main(int argc, char *argv[]) {
              gtk_init(&argc, &argv);

              GtkWidget *window = gtk_window_new(GTK_WINDOW_TOPLEVEL);
              gtk_window_set_default_size(GTK_WINDOW(window), 1024, 768);
              gtk_window_fullscreen(GTK_WINDOW(window));

              WebKitWebView *view = WEBKIT_WEB_VIEW(webkit_web_view_new());
              webkit_web_view_load_uri(view, "file:///usr/share/phantom-ui/index.html");

              gtk_container_add(GTK_CONTAINER(window), GTK_WIDGET(view));
              g_signal_connect(window, "destroy", G_CALLBACK(gtk_main_quit), NULL);
              gtk_widget_show_all(window);
              gtk_main();
              return 0;
          }
          EOF

          sudo chroot rootfs /bin/bash -c "
            cd /usr/local/bin &&
            gcc phantom-shell.c -o phantom-shell \$(pkg-config --cflags --libs webkit2gtk-4.1 gtk+-3.0) &&
            chmod +x phantom-shell &&
            rm phantom-shell.c
          "

      - name: Create blank HTML page
        run: |
          sudo mkdir -p rootfs/usr/share/phantom-ui
          sudo tee rootfs/usr/share/phantom-ui/index.html > /dev/null << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>Phantom OS</title>
            <style>
              body { 
                background: #000; 
                color: #0f0; 
                font-family: monospace; 
                display: flex; 
                justify-content: center; 
                align-items: center; 
                height: 100vh; 
                margin: 0; 
              }
              h1 { font-size: 3em; }
            </style>
          </head>
          <body>
            <h1>Phantom OS - Custom Kernel</h1>
          </body>
          </html>
          EOF

      - name: Create systemd service
        run: |
          sudo tee rootfs/etc/systemd/system/phantom.service > /dev/null << 'EOF'
          [Unit]
          Description=Phantom WebKit Shell
          After=graphical.target

          [Service]
          ExecStart=/usr/local/bin/phantom-shell
          Restart=always
          Environment=DISPLAY=:0

          [Install]
          WantedBy=graphical.target
          EOF

          sudo chroot rootfs systemctl enable phantom.service

      - name: Build initramfs
        run: |
          mkdir -p initramfs/{bin,sbin,etc,proc,sys,dev,newroot}
          wget https://www.busybox.net/downloads/binaries/1.35.0-x86_64-linux-musl/busybox -O initramfs/bin/busybox
          chmod +x initramfs/bin/busybox
          cd initramfs/bin
          for cmd in sh mount umount switch_root; do
            ln -s busybox $cmd
          done
          cd ../..
          
          cat > initramfs/init << 'EOF'
          #!/bin/sh
          mount -t proc none /proc
          mount -t sysfs none /sys
          mount -t devtmpfs none /dev
          
          mount -t iso9660 /dev/sr0 /newroot 2>/dev/null || mount -t squashfs /dev/loop0 /newroot
          
          exec switch_root /newroot /sbin/init
          EOF
          
          chmod +x initramfs/init
          cd initramfs
          find . | cpio -H newc -o | gzip > ../initramfs.cpio.gz

      - name: Build squashfs from rootfs
        run: |
          sudo mksquashfs rootfs filesystem.squashfs -comp xz -e boot

      - name: Prepare ISO structure
        run: |
          mkdir -p iso/boot/grub
          cp kernel-src/arch/x86/boot/bzImage iso/boot/vmlinuz
          cp initramfs.cpio.gz iso/boot/initramfs.gz
          cp filesystem.squashfs iso/boot/filesystem.squashfs

          cat > iso/boot/grub/grub.cfg << 'EOF'
          set default=0
          set timeout=5

          menuentry "Phantom OS (Custom Kernel)" {
              linux /boot/vmlinuz quiet splash
              initrd /boot/initramfs.gz
          }
          EOF

      - name: Build ISO
        run: |
          grub-mkrescue -o ${ISO_NAME} iso/

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: Phantom-OS
          path: Phantom-OS.iso
